<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Bot - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Header */
        .header {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Search & Filters */
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 16px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
        }

        .filter-dropdown {
            padding: 15px 25px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            min-width: 200px;
        }

        .filter-dropdown option {
            background: #1a1a2e;
            color: #fff;
        }

        .refresh-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
        }

        /* Table */
        .table-container {
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(255,255,255,0.05);
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.7);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
        }

        tr:hover {
            background: rgba(255,255,255,0.03);
        }

        .email-cell {
            font-weight: 500;
            color: #667eea;
        }

        .name-cell {
            color: rgba(255,255,255,0.9);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .status-exit-complete {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-exit-negative {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .status-exit-neutral {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }

        /* Confirmation Icons */
        .confirm-icon {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .confirm-icon:hover {
            transform: scale(1.2);
        }

        /* Action Buttons */
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
        }

        .btn-edit {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .btn-edit:hover {
            background: #667eea;
            color: #fff;
        }

        .btn-delete {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .btn-delete:hover {
            background: #e74c3c;
            color: #fff;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 600px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        .modal h2 {
            margin-bottom: 30px;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255,255,255,0.8);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group select option {
            background: #1a1a2e;
            padding: 10px;
        }

        .form-group .step-description {
            margin-top: 8px;
            padding: 10px 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .checkbox-group {
            display: flex;
            gap: 30px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-actions button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
        }

        .btn-save:hover {
            transform: scale(1.02);
        }

        .btn-cancel {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .btn-cancel:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 20px 30px;
            background: #2ecc71;
            color: #fff;
            border-radius: 12px;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #e74c3c;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px;
            color: rgba(255,255,255,0.5);
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 800px;
            }
        }

        /* Select2 Custom Styling */
        .select2-container--default .select2-selection--single {
            background: rgba(255,255,255,0.05) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            border-radius: 10px !important;
            height: 50px !important;
            padding: 10px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #fff !important;
            line-height: 28px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 48px !important;
        }

        .select2-dropdown {
            background: #1a1a2e !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
        }

        .select2-results__option {
            padding: 12px 15px !important;
            color: #fff !important;
        }

        .select2-results__option--highlighted {
            background: #667eea !important;
        }

        .select2-search__field {
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            color: #fff !important;
            padding: 10px !important;
        }

        .step-option-desc {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            margin-top: 3px;
        }

        /* Date display */
        .date-cell {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .page-btn {
            padding: 12px 24px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: #667eea;
            color: #fff;
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-info {
            font-weight: 600;
            color: rgba(255,255,255,0.8);
        }

        .records-info {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            margin-left: 20px;
        }

        /* Sortable column header */
        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            color: #667eea;
        }

        th .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
        }

        th.active .sort-icon {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">üìä Review Bot Admin</div>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="pendingApprovals" style="color: #f39c12;">0</div>
                <div class="stat-label">Pending Approvals</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalLeads">0</div>
                <div class="stat-label">Total Leads</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="activeLeads">0</div>
                <div class="stat-label">Active</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completedLeads">0</div>
                <div class="stat-label">Completed</div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-navigation" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="tab-btn active" onclick="switchTab('leads')" id="tabLeads" style="padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff;">üìã All Leads</button>
            <button class="tab-btn" onclick="switchTab('approvals')" id="tabApprovals" style="padding: 12px 24px; border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; font-weight: 600; cursor: pointer; background: rgba(255,255,255,0.05); color: #fff;">
                üìù Project Acceptance Requests <span id="pendingBadge" style="background: #f39c12; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 5px;">0</span>
            </button>
        </div>

        <!-- PROJECT ACCEPTANCE REQUESTS SECTION -->
        <div id="approvalsSection" style="display: none;">
            <div class="section-header" style="margin-bottom: 20px;">
                <h2 style="font-size: 20px; color: #fff; margin-bottom: 10px;">üìù Project Acceptance Requests</h2>
                <p style="color: rgba(255,255,255,0.6); font-size: 14px;">Users who clicked "Project Accepted" - Verify on Upwork before approving</p>
            </div>
            
            <div class="table-container" id="approvalsTableContainer">
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Requested At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="approvalsTable">
                    </tbody>
                </table>
            </div>
            
            <div class="empty-state" id="approvalsEmpty" style="display: none;">
                <div class="icon">‚úÖ</div>
                <h3>No Pending Approvals</h3>
                <p>All project acceptance requests have been processed</p>
            </div>
        </div>

        <!-- LEADS SECTION -->
        <div id="leadsSection">
            <!-- Controls -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by email or name...">
                </div>
                <select class="filter-dropdown" id="statusFilter">
                    <option value="">All Statuses</option>
                    <optgroup label="Active Steps">
                        <option value="Step 1">Step 1 - Compliance</option>
                        <option value="Step 2A">Step 2A - Amazon Check</option>
                        <option value="Step 3A">Step 3A - Task Details</option>
                        <option value="Step 3B">Step 3B - Final Decision</option>
                        <option value="Step 4A">Step 4A - Project Not Accepted</option>
                        <option value="Step 4A-Pending">Step 4A-Pending - Awaiting Approval</option>
                        <option value="Step 4B">Step 4B - Send Kindle Details</option>
                        <option value="Step 4C">Step 4C - Day 2 Book 1</option>
                        <option value="Step 4D">Step 4D - Day 2 Book 2</option>
                        <option value="Step 5A">Step 5A - Day 3</option>
                        <option value="Step 5B">Step 5B - Day 4</option>
                        <option value="Step 5C">Step 5C - Day 5</option>
                        <option value="Step 5D">Step 5D - Email Confirmation</option>
                    </optgroup>
                    <optgroup label="Exit Steps">
                        <option value="Exit - Project Complete">‚úÖ Project Complete</option>
                        <option value="Exit - Not Interested">‚ùå Not Interested</option>
                        <option value="Exit - Ineligible">‚ö†Ô∏è Ineligible</option>
                        <option value="Exit - Forwarded">üìû Forwarded to Operator</option>
                    </optgroup>
                </select>
                <button class="refresh-btn" onclick="loadLeads()">üîÑ Refresh</button>
                <select class="filter-dropdown" id="sortDropdown" style="min-width: 180px;">
                    <option value="last_updated_desc">üìÖ Newest First</option>
                    <option value="last_updated_asc">üìÖ Oldest First</option>
                    <option value="name_asc">üî§ Name A-Z</option>
                    <option value="name_desc">üî§ Name Z-A</option>
                    <option value="email_asc">üìß Email A-Z</option>
                </select>
            </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading leads...</p>
        </div>

        <!-- Table -->
        <div class="table-container" id="tableContainer" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Book 1</th>
                        <th>Book 2</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="leadsTable">
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="icon">üì≠</div>
            <h3>No leads found</h3>
            <p>Try adjusting your search or filter</p>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" onclick="changePage(-1)" id="prevBtn">‚Üê Previous</button>
            <span class="page-info" id="pageInfo">Page 1 of 1</span>
            <button class="page-btn" onclick="changePage(1)" id="nextBtn">Next ‚Üí</button>
            <span class="records-info" id="recordsInfo">Showing 1-10 of 100</span>
        </div>
        </div><!-- End leadsSection -->
    </div>

    <!-- Rejection Modal -->
    <div class="modal-overlay" id="rejectModal">
        <div class="modal">
            <h2>‚ùå Reject Project Acceptance</h2>
            <form id="rejectForm">
                <input type="hidden" id="rejectKey">
                <input type="hidden" id="rejectEmail">
                
                <div class="form-group">
                    <label>Rejection Reason</label>
                    <select id="rejectReason" style="width: 100%; padding: 15px; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; background: rgba(255,255,255,0.05); color: #fff; font-size: 16px;">
                        <option value="not_found">Project not found on Upwork</option>
                        <option value="not_accepted">Project not accepted on Upwork yet</option>
                        <option value="different_user">User doesn't match Upwork freelancer</option>
                        <option value="other">Other reason</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Additional Notes (optional)</label>
                    <input type="text" id="rejectNotes" placeholder="Enter additional notes...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeRejectModal()">Cancel</button>
                    <button type="submit" class="btn-save" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">‚ùå Confirm Rejection</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h2>‚úèÔ∏è Edit Lead</h2>
            <form id="editForm">
                <input type="hidden" id="editKey">
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editEmail" readonly style="opacity: 0.6;">
                </div>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editName">
                </div>

                <div class="form-group">
                    <label>Bot Step</label>
                    <select id="editBotStep">
                        <optgroup label="Active Steps">
                            <option value="Step 1 - Compliance">Step 1 - Compliance</option>
                            <option value="Step 2A - Amazon Check">Step 2A - Amazon Check</option>
                            <option value="Step 3A - Task Details">Step 3A - Task Details</option>
                            <option value="Step 3B - Final Decision">Step 3B - Final Decision</option>
                            <option value="Step 4A - Project Not Accepted Yet">Step 4A - Project Not Accepted Yet</option>
                            <option value="Step 4A-Pending - Awaiting Admin Approval">Step 4A-Pending - Awaiting Admin Approval</option>
                            <option value="Step 4B - Send Kindle Details">Step 4B - Send Kindle Details</option>
                            <option value="Step 4C - Day 2 Book 1">Step 4C - Day 2 Book 1</option>
                            <option value="Step 4D - Day 2 Book 2">Step 4D - Day 2 Book 2</option>
                            <option value="Step 5A - Day 3 Instructions">Step 5A - Day 3 Instructions</option>
                            <option value="Step 5B - Day 4 Instructions">Step 5B - Day 4 Instructions</option>
                            <option value="Step 5C - Day 5 Instructions">Step 5C - Day 5 Instructions</option>
                            <option value="Step 5D - Day 5 Email Confirmation">Step 5D - Day 5 Email Confirmation</option>
                        </optgroup>
                        <optgroup label="Exit Steps">
                            <option value="Exit - Project Complete">Exit - Project Complete</option>
                            <option value="Exit - Not Interested">Exit - Not Interested</option>
                            <option value="Exit - Ineligible">Exit - Ineligible</option>
                            <option value="Exit - Forwarded to Operator">Exit - Forwarded to Operator</option>
                            <option value="Exit - Interested in Future Projects">Exit - Interested in Future Projects</option>
                            <option value="Exit - Not Interested in Future">Exit - Not Interested in Future</option>
                        </optgroup>
                    </select>
                    <div class="step-description" id="stepDescription"></div>
                </div>

                <div class="form-group">
                    <label>Email Confirmations</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="editBook1">
                            <span>üìò Book 1 Confirmed</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="editBook2">
                            <span>üìó Book 2 Confirmed</span>
                        </label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-save">üíæ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">Changes saved successfully!</div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const FIREBASE_URL = "https://review-chat-b1996-default-rtdb.firebaseio.com";
        
        // Master Step Definitions (add new steps here when needed)
        const STEP_DEFINITIONS = {
            "Step 1 - Compliance": "Initial - Upwork compliance agreement",
            "Step 2A - Amazon Check": "Checking Amazon $50 spend requirement",
            "Step 3A - Task Details": "Ask if user wants task details",
            "Step 3B - Final Decision": "Detailed task instructions, awaiting assignment",
            "Step 4A - Project Not Accepted Yet": "Waiting for project acceptance",
            "Step 4A-Pending - Awaiting Admin Approval": "‚è≥ User clicked accepted, pending admin verification",
            "Step 4B - Send Kindle Details": "Project accepted, sending Kindle details",
            "Step 4C - Day 2 Book 1": "Day 1 done, waiting for Day 2 Book 1 screenshots",
            "Step 4D - Day 2 Book 2": "Day 2 Book 1 done, waiting for Book 2 screenshots",
            "Step 5A - Day 3 Instructions": "Day 3 - both books being flipped",
            "Step 5B - Day 4 Instructions": "Day 4 - Book 1 review posting",
            "Step 5C - Day 5 Instructions": "Day 5 - Book 2 review posting",
            "Step 5D - Day 5 Email Confirmation": "Waiting for email confirmations (Book 1 & Book 2)",
            "Exit - Project Complete": "‚úÖ Both books confirmed, project done",
            "Exit - Not Interested": "‚ùå User not interested at Step 1",
            "Exit - Ineligible": "‚ö†Ô∏è User doesn't meet Amazon $50 requirement",
            "Exit - Forwarded to Operator": "üìû User requested operator",
            "Exit - Interested in Future Projects": "‚úÖ Completed, wants future notifications",
            "Exit - Not Interested in Future": "‚ùå Completed, no future notifications"
        };

        let allLeads = {};
        let currentPage = 1;
        const recordsPerPage = 10;
        let sortField = 'last_updated';
        let sortOrder = 'desc'; // desc = newest first
        let currentTab = 'leads';

        // ============================================
        // TAB SWITCHING
        // ============================================
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab button styles
            document.getElementById('tabLeads').style.background = tab === 'leads' 
                ? 'linear-gradient(135deg, #667eea, #764ba2)' 
                : 'rgba(255,255,255,0.05)';
            document.getElementById('tabLeads').style.border = tab === 'leads' 
                ? 'none' 
                : '1px solid rgba(255,255,255,0.2)';
            
            document.getElementById('tabApprovals').style.background = tab === 'approvals' 
                ? 'linear-gradient(135deg, #f39c12, #e67e22)' 
                : 'rgba(255,255,255,0.05)';
            document.getElementById('tabApprovals').style.border = tab === 'approvals' 
                ? 'none' 
                : '1px solid rgba(255,255,255,0.2)';
            
            // Show/hide sections
            document.getElementById('leadsSection').style.display = tab === 'leads' ? 'block' : 'none';
            document.getElementById('approvalsSection').style.display = tab === 'approvals' ? 'block' : 'none';
            
            if (tab === 'approvals') {
                renderApprovals();
            }
        }

        // ============================================
        // RENDER PENDING APPROVALS
        // ============================================
        function renderApprovals() {
            const tbody = document.getElementById('approvalsTable');
            
            // Filter leads with pending approval status
            const pendingLeads = Object.entries(allLeads)
                .filter(([key, lead]) => lead.bot_step === 'Step 4A-Pending - Awaiting Admin Approval')
                .map(([key, lead]) => ({ key, ...lead }))
                .sort((a, b) => {
                    const dateA = a.project_accepted_at ? new Date(a.project_accepted_at).getTime() : 0;
                    const dateB = b.project_accepted_at ? new Date(b.project_accepted_at).getTime() : 0;
                    return dateB - dateA; // Newest first
                });
            
            if (pendingLeads.length === 0) {
                document.getElementById('approvalsTableContainer').style.display = 'none';
                document.getElementById('approvalsEmpty').style.display = 'block';
                return;
            }
            
            document.getElementById('approvalsTableContainer').style.display = 'block';
            document.getElementById('approvalsEmpty').style.display = 'none';
            
            let html = '';
            for (const lead of pendingLeads) {
                const requestedAt = formatDate(lead.project_accepted_at || lead.last_updated);
                
                html += `
                    <tr>
                        <td class="email-cell">${lead.email || '-'}</td>
                        <td class="name-cell">${lead.name || '-'}</td>
                        <td class="date-cell">${requestedAt}</td>
                        <td>
                            <button class="action-btn" onclick="approveProject('${lead.key}', '${lead.email}', '${lead.name || 'User'}')" 
                                style="background: rgba(46, 204, 113, 0.2); color: #2ecc71; margin-right: 8px;">
                                ‚úÖ Approve
                            </button>
                            <button class="action-btn" onclick="openRejectModal('${lead.key}', '${lead.email}')" 
                                style="background: rgba(231, 76, 60, 0.2); color: #e74c3c;">
                                ‚ùå Reject
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html;
        }

        // ============================================
        // APPROVE PROJECT
        // ============================================
        async function approveProject(key, email, name) {
            if (!confirm(`Approve project for ${email}?\n\nThis will:\n1. Update status to Step 4B\n2. Send approval email to user\n3. Reveal book details in chat`)) {
                return;
            }
            
            try {
                // Update Firebase
                await fetch(`${FIREBASE_URL}/leads/${key}.json`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        bot_step: 'Step 4B - Send Kindle Details',
                        admin_approved: true,
                        admin_approved_at: new Date().toISOString(),
                        last_updated: new Date().toISOString()
                    })
                });
                
                // Send approval email via EmailJS or your email service
                await sendApprovalEmail(email, name);
                
                // Update local data
                allLeads[key].bot_step = 'Step 4B - Send Kindle Details';
                allLeads[key].admin_approved = true;
                allLeads[key].admin_approved_at = new Date().toISOString();
                
                renderApprovals();
                updateStats(allLeads);
                showToast(`‚úÖ Project approved for ${email}`);
                
            } catch (error) {
                console.error('Error approving project:', error);
                showToast('Error approving project', true);
            }
        }

        // ============================================
        // SEND APPROVAL EMAIL VIA ZOHO FLOW WEBHOOK
        // ============================================
        async function sendApprovalEmail(email, name) {
            // ==============================================
            // ZOHO FLOW WEBHOOK SETUP INSTRUCTIONS:
            // ==============================================
            // 1. Go to Zoho Flow (flow.zoho.com)
            // 2. Create new Flow ‚Üí "Start from scratch"
            // 3. Trigger: "Webhook" ‚Üí Copy the webhook URL
            // 4. Action: "Zoho Mail" ‚Üí "Send Email"
            //    - To: {{email}}
            //    - Subject: Project Approved - Book Details Now Available
            //    - Body: Use the template below with {{name}} variable
            // 5. Replace ZOHO_FLOW_WEBHOOK_URL below with your webhook URL
            // ==============================================
            
            const ZOHO_FLOW_WEBHOOK_URL = 'https://flow.zoho.com/913651648/flow/webhook/incoming?zapikey=1001.eaa6a7b3cce15d299d976ce40e8d2328.538729a0f44b72d3d8445a2d8671ea8b&isdebug=false';
            
            const emailData = {
                to_email: email,
                to_name: name || 'User',
                subject: 'Project Approved - Book Details Now Available',
                message: `Dear ${name || 'User'},

Great news! Your project has been approved! üéâ

Book details are now available in your chat.

üîó Access your details here: https://mednursing.github.io/ExamPrep/

IMPORTANT: All communication regarding this project will happen exclusively through https://mednursing.github.io/ExamPrep/

Please do not reply to this email. Return to the chat to view your book details and continue the process.

Thank you!`
            };
            
            // Log for debugging
            console.log('üìß Sending Approval Email via Zoho Flow:');
            console.log('To:', email);
            console.log('Name:', name);
            
            // Check if webhook URL is configured
            if (ZOHO_FLOW_WEBHOOK_URL === 'YOUR_ZOHO_FLOW_WEBHOOK_URL') {
                console.warn('‚ö†Ô∏è Zoho Flow webhook not configured. Email not sent.');
                console.log('üìã Email would be:', emailData);
                showToast('‚ö†Ô∏è Email not sent - Configure Zoho Flow webhook', true);
                return false;
            }
            
            try {
                const response = await fetch(ZOHO_FLOW_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emailData)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Email sent successfully via Zoho Flow');
                    return true;
                } else {
                    console.error('‚ùå Zoho Flow webhook error:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error calling Zoho Flow webhook:', error);
                return false;
            }
        }

        // ============================================
        // REJECT PROJECT - MODAL
        // ============================================
        function openRejectModal(key, email) {
            document.getElementById('rejectKey').value = key;
            document.getElementById('rejectEmail').value = email;
            document.getElementById('rejectReason').value = 'not_found';
            document.getElementById('rejectNotes').value = '';
            document.getElementById('rejectModal').classList.add('active');
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').classList.remove('active');
        }

        document.getElementById('rejectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const key = document.getElementById('rejectKey').value;
            const email = document.getElementById('rejectEmail').value;
            const reason = document.getElementById('rejectReason').value;
            const notes = document.getElementById('rejectNotes').value;
            
            const reasonTexts = {
                'not_found': 'Project not found on Upwork',
                'not_accepted': 'Project not accepted on Upwork yet',
                'different_user': 'User doesn\'t match Upwork freelancer',
                'other': 'Other reason'
            };
            
            try {
                // Update Firebase - keep in pending step, bot will handle the rejection message
                await fetch(`${FIREBASE_URL}/leads/${key}.json`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        bot_step: 'Step 4A-Pending - Awaiting Admin Approval',
                        admin_rejected: true,
                        admin_rejected_at: new Date().toISOString(),
                        rejection_reason: reasonTexts[reason],
                        rejection_notes: notes,
                        last_updated: new Date().toISOString()
                    })
                });
                
                // Update local data
                allLeads[key].bot_step = 'Step 4A-Pending - Awaiting Admin Approval';
                allLeads[key].admin_rejected = true;
                
                closeRejectModal();
                renderApprovals();
                updateStats(allLeads);
                showToast(`‚ùå Project rejected for ${email}`);
                
            } catch (error) {
                console.error('Error rejecting project:', error);
                showToast('Error rejecting project', true);
            }
        });

        // Close reject modal on outside click
        document.getElementById('rejectModal').addEventListener('click', function(e) {
            if (e.target === this) closeRejectModal();
        });

        // ============================================
        // LOAD LEADS
        // ============================================
        async function loadLeads() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            try {
                const response = await fetch(`${FIREBASE_URL}/leads.json`);
                const data = await response.json();
                
                allLeads = data || {};
                renderLeads(allLeads);
                updateStats(allLeads);
            } catch (error) {
                console.error('Error loading leads:', error);
                showToast('Error loading leads', true);
            }

            document.getElementById('loading').classList.remove('active');
        }

        // ============================================
        // RENDER LEADS TABLE
        // ============================================
        function renderLeads(leads) {
            const tbody = document.getElementById('leadsTable');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            // Convert to array and filter
            let leadsArray = Object.entries(leads).map(([key, lead]) => ({
                key,
                ...lead
            }));

            // Apply search filter
            if (searchTerm) {
                leadsArray = leadsArray.filter(lead => 
                    (lead.email && lead.email.toLowerCase().includes(searchTerm)) ||
                    (lead.name && lead.name.toLowerCase().includes(searchTerm))
                );
            }

            // Apply status filter
            if (statusFilter) {
                leadsArray = leadsArray.filter(lead => 
                    lead.bot_step && lead.bot_step.includes(statusFilter)
                );
            }

            // Sort
            leadsArray.sort((a, b) => {
                let valA, valB;
                
                if (sortField === 'last_updated') {
                    valA = a.last_updated ? new Date(a.last_updated).getTime() : 0;
                    valB = b.last_updated ? new Date(b.last_updated).getTime() : 0;
                } else if (sortField === 'name') {
                    valA = (a.name || '').toLowerCase();
                    valB = (b.name || '').toLowerCase();
                } else if (sortField === 'email') {
                    valA = (a.email || '').toLowerCase();
                    valB = (b.email || '').toLowerCase();
                } else {
                    valA = a[sortField] || '';
                    valB = b[sortField] || '';
                }

                if (sortOrder === 'asc') {
                    return valA > valB ? 1 : valA < valB ? -1 : 0;
                } else {
                    return valA < valB ? 1 : valA > valB ? -1 : 0;
                }
            });

            // Pagination
            const totalRecords = leadsArray.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            
            // Ensure current page is valid
            if (currentPage > totalPages) currentPage = totalPages || 1;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, totalRecords);
            const paginatedLeads = leadsArray.slice(startIndex, endIndex);

            // Render table
            let html = '';
            for (const lead of paginatedLeads) {
                const statusClass = getStatusClass(lead.bot_step);
                const formattedDate = formatDate(lead.last_updated);

                html += `
                    <tr>
                        <td class="email-cell">${lead.email || '-'}</td>
                        <td class="name-cell">${lead.name || '-'}</td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${getShortStatus(lead.bot_step)}
                            </span>
                        </td>
                        <td>
                            <span class="confirm-icon" onclick="toggleBook1('${lead.key}')" title="Click to toggle">
                                ${lead.book1_confirmed ? '‚úÖ' : '‚¨ú'}
                            </span>
                        </td>
                        <td>
                            <span class="confirm-icon" onclick="toggleBook2('${lead.key}')" title="Click to toggle">
                                ${lead.book2_confirmed ? '‚úÖ' : '‚¨ú'}
                            </span>
                        </td>
                        <td class="date-cell">${formattedDate}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editLead('${lead.key}')">‚úèÔ∏è Edit</button>
                            <button class="action-btn btn-delete" onclick="deleteLead('${lead.key}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }

            tbody.innerHTML = html;

            // Update pagination UI
            updatePaginationUI(totalRecords, totalPages, startIndex, endIndex);

            if (totalRecords > 0) {
                document.getElementById('tableContainer').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('pagination').style.display = 'flex';
            } else {
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('pagination').style.display = 'none';
            }
        }

        // ============================================
        // PAGINATION CONTROLS
        // ============================================
        function updatePaginationUI(totalRecords, totalPages, startIndex, endIndex) {
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
            document.getElementById('recordsInfo').textContent = 
                totalRecords > 0 
                    ? `Showing ${startIndex + 1}-${endIndex} of ${totalRecords}` 
                    : 'No records';
            
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function changePage(delta) {
            currentPage += delta;
            renderLeads(allLeads);
        }

        // ============================================
        // SORTING
        // ============================================
        function handleSort() {
            const sortValue = document.getElementById('sortDropdown').value;
            const [field, order] = sortValue.split('_');
            sortField = field;
            sortOrder = order;
            currentPage = 1; // Reset to first page on sort change
            renderLeads(allLeads);
        }

        // ============================================
        // QUICK TOGGLE BOOK CONFIRMATIONS
        // ============================================
        async function toggleBook1(key) {
            const lead = allLeads[key];
            const newValue = !lead.book1_confirmed;
            
            try {
                await fetch(`${FIREBASE_URL}/leads/${key}.json`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        book1_confirmed: newValue,
                        last_updated: new Date().toISOString()
                    })
                });
                
                allLeads[key].book1_confirmed = newValue;
                renderLeads(allLeads);
                showToast(`Book 1: ${newValue ? 'Confirmed ‚úÖ' : 'Unconfirmed ‚¨ú'}`);
            } catch (error) {
                showToast('Error updating', true);
            }
        }

        async function toggleBook2(key) {
            const lead = allLeads[key];
            const newValue = !lead.book2_confirmed;
            
            try {
                await fetch(`${FIREBASE_URL}/leads/${key}.json`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        book2_confirmed: newValue,
                        last_updated: new Date().toISOString()
                    })
                });
                
                allLeads[key].book2_confirmed = newValue;
                renderLeads(allLeads);
                showToast(`Book 2: ${newValue ? 'Confirmed ‚úÖ' : 'Unconfirmed ‚¨ú'}`);
            } catch (error) {
                showToast('Error updating', true);
            }
        }

        // ============================================
        // EDIT LEAD
        // ============================================
        function editLead(key) {
            const lead = allLeads[key];
            
            document.getElementById('editKey').value = key;
            document.getElementById('editEmail').value = lead.email || '';
            document.getElementById('editName').value = lead.name || '';
            document.getElementById('editBotStep').value = lead.bot_step || 'Step 1 - Compliance';
            document.getElementById('editBook1').checked = lead.book1_confirmed || false;
            document.getElementById('editBook2').checked = lead.book2_confirmed || false;
            
            updateStepDescription();
            document.getElementById('editModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function updateStepDescription() {
            const step = document.getElementById('editBotStep').value;
            const desc = STEP_DEFINITIONS[step] || '';
            document.getElementById('stepDescription').textContent = desc;
        }

        document.getElementById('editBotStep').addEventListener('change', updateStepDescription);

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const key = document.getElementById('editKey').value;
            const updateData = {
                name: document.getElementById('editName').value,
                bot_step: document.getElementById('editBotStep').value,
                book1_confirmed: document.getElementById('editBook1').checked,
                book2_confirmed: document.getElementById('editBook2').checked,
                last_updated: new Date().toISOString()
            };

            try {
                await fetch(`${FIREBASE_URL}/leads/${key}.json`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });
                
                // Update local data
                Object.assign(allLeads[key], updateData);
                renderLeads(allLeads);
                updateStats(allLeads);
                closeModal();
                showToast('Lead updated successfully!');
            } catch (error) {
                showToast('Error updating lead', true);
            }
        });

        // ============================================
        // DELETE LEAD
        // ============================================
        async function deleteLead(key) {
            if (!confirm('Are you sure you want to delete this lead?')) return;
            
            try {
                await fetch(`${FIREBASE_URL}/leads/${key}.json`, {
                    method: 'DELETE'
                });
                
                delete allLeads[key];
                renderLeads(allLeads);
                updateStats(allLeads);
                showToast('Lead deleted');
            } catch (error) {
                showToast('Error deleting lead', true);
            }
        }

        // ============================================
        // HELPERS
        // ============================================
        function getStatusClass(status) {
            if (!status) return 'status-active';
            if (status.includes('Exit - Project Complete') || status.includes('Interested in Future')) {
                return 'status-exit-complete';
            }
            if (status.includes('Exit - Not') || status.includes('Ineligible')) {
                return 'status-exit-negative';
            }
            if (status.includes('Exit')) {
                return 'status-exit-neutral';
            }
            return 'status-active';
        }

        function getShortStatus(status) {
            if (!status) return 'Unknown';
            // Extract just the step number/name
            const match = status.match(/Step \d+[A-D]?|Exit - [^-]+/);
            return match ? match[0] : status.substring(0, 20);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return dateStr;
            }
        }

        function updateStats(leads) {
            let total = 0, active = 0, completed = 0, pending = 0;
            
            for (const lead of Object.values(leads)) {
                total++;
                if (lead.bot_step && lead.bot_step.includes('Exit - Project Complete')) {
                    completed++;
                } else if (lead.bot_step && lead.bot_step.includes('Step 4A-Pending')) {
                    pending++;
                    active++;
                } else if (lead.bot_step && !lead.bot_step.includes('Exit')) {
                    active++;
                }
            }
            
            document.getElementById('totalLeads').textContent = total;
            document.getElementById('activeLeads').textContent = active;
            document.getElementById('completedLeads').textContent = completed;
            document.getElementById('pendingApprovals').textContent = pending;
            document.getElementById('pendingBadge').textContent = pending;
            
            // Highlight pending badge if there are pending approvals
            document.getElementById('pendingBadge').style.background = pending > 0 ? '#e74c3c' : '#f39c12';
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1; // Reset to first page on search
            renderLeads(allLeads);
        });
        document.getElementById('statusFilter').addEventListener('change', () => {
            currentPage = 1; // Reset to first page on filter
            renderLeads(allLeads);
        });
        document.getElementById('sortDropdown').addEventListener('change', handleSort);

        // Close modal on outside click
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // ============================================
        // INITIALIZE
        // ============================================
        loadLeads();
    </script>
</body>
</html>
